#!/bin/bash

# DevTool - Naver Real Estate ê°œë°œ ë„êµ¬ í†µí•© ê´€ë¦¬

PROJECT_ROOT="/Users/specialrisk_mac/code_work/naver_realestate"
cd "$PROJECT_ROOT"

print_header() {
    clear
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                        â•‘"
    echo "â•‘       ğŸ› ï¸  Naver Real Estate DevTool                     â•‘"
    echo "â•‘          í†µí•© ê°œë°œ ë„êµ¬ & ëª¨ë‹ˆí„°ë§                     â•‘"
    echo "â•‘                                                        â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

check_status() {
    echo "ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    docker ps 2>/dev/null | grep -q "postgres" && echo "  âœ… PostgreSQL (í¬íŠ¸ 5433)" || echo "  âŒ PostgreSQL"
    docker ps 2>/dev/null | grep -q "redis" && echo "  âœ… Redis (í¬íŠ¸ 6380)" || echo "  âŒ Redis"
    curl -s http://localhost:8000/health > /dev/null 2>&1 && echo "  âœ… Backend API (í¬íŠ¸ 8000)" || echo "  âš ï¸  Backend API"
    curl -s http://localhost:3000 > /dev/null 2>&1 && echo "  âœ… Frontend (í¬íŠ¸ 3000)" || echo "  âš ï¸  Frontend"
    pgrep -f "celery.*worker" > /dev/null 2>&1 && echo "  âœ… Celery Worker" || echo "  âš ï¸  Celery Worker"
    pgrep -f "celery.*beat" > /dev/null 2>&1 && echo "  âœ… Celery Beat" || echo "  âš ï¸  Celery Beat"
    
    echo ""
}

show_main_menu() {
    print_header
    check_status
    
    echo "ğŸ“‹ ë©”ì¸ ë©”ë‰´"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸ—„ï¸  ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬"
    echo "  [2] ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    echo "  [3] ğŸ“Š ëª¨ë‹ˆí„°ë§ & ìƒíƒœ"
    echo "  [4] ğŸš€ ì„œë¹„ìŠ¤ ê´€ë¦¬"
    echo "  [5] ğŸ“š ë¬¸ì„œ ë³´ê¸°"
    echo ""
    echo "  [0] ğŸšª ì¢…ë£Œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) database_menu ;;
        2) test_menu ;;
        3) monitoring_menu ;;
        4) service_menu ;;
        5) docs_menu ;;
        0) echo ""; echo "ğŸ‘‹ DevToolì„ ì¢…ë£Œí•©ë‹ˆë‹¤."; echo ""; exit 0 ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; show_main_menu ;;
    esac
}

database_menu() {
    print_header
    echo "ğŸ—„ï¸  ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸ“Š ë‚´ìš© í™•ì¸"
    echo "  [2] ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜"
    echo "  [3] ğŸ—‘ï¸  ì´ˆê¸°í™” [ìœ„í—˜]"
    echo "  [4] ğŸ˜ PostgreSQL ì ‘ì†"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) echo ""; backend/.venv/bin/python scripts/check_data.py; echo ""; read -p "ì—”í„°..."; database_menu ;;
        2) echo ""; printf "ê³„ì†? (y/N) "; read c; [[ "$c" == "y" ]] && backend/.venv/bin/python scripts/migrate_db.py; echo ""; read -p "ì—”í„°..."; database_menu ;;
        3) echo ""; printf "yes ì…ë ¥: "; read c; [[ "$c" == "yes" ]] && backend/.venv/bin/python scripts/reset_db.py; echo ""; read -p "ì—”í„°..."; database_menu ;;
        4) echo ""; docker exec -it naver_realestate-postgres-1 psql -U postgres -d naver_realestate; echo ""; read -p "ì—”í„°..."; database_menu ;;
        0) show_main_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; database_menu ;;
    esac
}

test_menu() {
    print_header
    echo "ğŸ§ª í…ŒìŠ¤íŠ¸"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸŒ API í…ŒìŠ¤íŠ¸"
    echo "  [2] ğŸ’° ì‹¤ê±°ë˜ê°€ í…ŒìŠ¤íŠ¸"
    echo "  [3] ğŸ’¬ Discord í…ŒìŠ¤íŠ¸"
    echo "  [4] ğŸ”„ ì „ì²´ í…ŒìŠ¤íŠ¸"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) echo ""; ./tests/test_api.sh; echo ""; read -p "ì—”í„°..."; test_menu ;;
        2) echo ""; ./tests/test_transaction_api.sh; echo ""; read -p "ì—”í„°..."; test_menu ;;
        3) echo ""; ./tests/test_discord_briefing.sh; echo ""; read -p "ì—”í„°..."; test_menu ;;
        4) echo ""; ./tests/test_api.sh; ./tests/test_transaction_api.sh; ./tests/test_discord_briefing.sh; echo "âœ… ì™„ë£Œ"; echo ""; read -p "ì—”í„°..."; test_menu ;;
        0) show_main_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; test_menu ;;
    esac
}

monitoring_menu() {
    print_header
    echo "ğŸ“Š ëª¨ë‹ˆí„°ë§"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸ“… ìŠ¤ì¼€ì¤„ ìƒíƒœ"
    echo "  [2] ğŸ“œ ë¡œê·¸ ë³´ê¸°"
    echo "  [3] ğŸ³ Docker ìƒíƒœ"
    echo "  [4] ğŸ” í”„ë¡œì„¸ìŠ¤ ìƒíƒœ"
    echo "  [5] ğŸŒ ì›¹ UI ì—´ê¸°"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) echo ""; ./scripts/check_schedules.sh; echo ""; read -p "ì—”í„°..."; monitoring_menu ;;
        2) ./scripts/logs_all.sh ;;
        3) echo ""; docker ps; echo ""; read -p "ì—”í„°..."; monitoring_menu ;;
        4) echo ""; ps aux | grep -E "uvicorn|celery|next" | grep -v grep; echo ""; read -p "ì—”í„°..."; monitoring_menu ;;
        5) open http://localhost:3000 2>/dev/null; open http://localhost:8000/docs 2>/dev/null; monitoring_menu ;;
        0) show_main_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; monitoring_menu ;;
    esac
}

service_menu() {
    print_header
    echo "ğŸš€ ì„œë¹„ìŠ¤ ê´€ë¦¬"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸŸ¢ ì „ì²´ ì‹œì‘"
    echo "  [2] ğŸ”´ ì „ì²´ ì¤‘ì§€"
    echo "  [3] ğŸ”„ Docker ì‹œì‘"
    echo "  [4] ğŸ›‘ Docker ì¤‘ì§€"
    echo "  [5] ğŸ”§ ê°œë³„ ê´€ë¦¬"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice

    case $choice in
        1) echo ""; ./scripts/start_all.sh; echo ""; read -p "ì—”í„°..."; service_menu ;;
        2) echo ""; ./scripts/stop_all.sh; echo ""; read -p "ì—”í„°..."; service_menu ;;
        3) echo ""; docker-compose up -d; echo ""; read -p "ì—”í„°..."; service_menu ;;
        4) echo ""; docker-compose down; echo ""; read -p "ì—”í„°..."; service_menu ;;
        5) individual_menu ;;
        0) show_main_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; service_menu ;;
    esac
}

individual_menu() {
    print_header
    echo "ğŸ”§ ê°œë³„ ì„œë¹„ìŠ¤"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  ì‹œì‘: [1]Backend [2]Worker [3]Beat [4]Frontend"
    echo "  ì¤‘ì§€: [5]Backend [6]Worker [7]Beat [8]Frontend"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) cd backend && nohup .venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > ../logs/backend.log 2>&1 & echo "âœ… Backend ì‹œì‘"; sleep 2; individual_menu ;;
        2) cd backend && nohup ./run_celery_worker.sh > ../logs/worker.log 2>&1 & echo "âœ… Worker ì‹œì‘"; sleep 2; individual_menu ;;
        3) cd backend && nohup ./run_celery_beat.sh > ../logs/beat.log 2>&1 & echo "âœ… Beat ì‹œì‘"; sleep 2; individual_menu ;;
        4) cd frontend && nohup npm run dev > ../logs/frontend.log 2>&1 & echo "âœ… Frontend ì‹œì‘"; sleep 2; individual_menu ;;
        5) pkill -f "uvicorn app.main:app"; echo "ğŸ”´ Backend ì¤‘ì§€"; sleep 1; individual_menu ;;
        6) pkill -f "celery.*worker"; echo "ğŸ”´ Worker ì¤‘ì§€"; sleep 1; individual_menu ;;
        7) pkill -f "celery.*beat"; echo "ğŸ”´ Beat ì¤‘ì§€"; sleep 1; individual_menu ;;
        8) pkill -f "next-server"; echo "ğŸ”´ Frontend ì¤‘ì§€"; sleep 1; individual_menu ;;
        0) service_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; individual_menu ;;
    esac
}

docs_menu() {
    print_header
    echo "ğŸ“š ë¬¸ì„œ"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  [1] ğŸ“– ì‹œì‘ ê°€ì´ë“œ"
    echo "  [2] ğŸ¤– ê°œë°œ ê°€ì´ë“œ"
    echo "  [3] ğŸ—„ï¸  ìŠ¤í¬ë¦½íŠ¸"
    echo "  [4] ğŸ§ª í…ŒìŠ¤íŠ¸"
    echo "  [5] ğŸ—ï¸  í”„ë¡œì íŠ¸ êµ¬ì¡°"
    echo "  [6] ğŸ› ï¸  DevTool"
    echo "  [0] â¬…ï¸  ë’¤ë¡œ"
    echo ""
    printf "ì„ íƒ â¤ "
    read choice
    
    case $choice in
        1) less README_STARTUP.md; docs_menu ;;
        2) less CLAUDE.md; docs_menu ;;
        3) less scripts/README.md; docs_menu ;;
        4) less tests/README.md; docs_menu ;;
        5) less docs/PROJECT_STRUCTURE.md; docs_menu ;;
        6) less DEVTOOL.md; docs_menu ;;
        0) show_main_menu ;;
        *) echo "âŒ ì˜ëª»ëœ ì„ íƒ"; sleep 1; docs_menu ;;
    esac
}

[ "$1" == "--help" ] || [ "$1" == "-h" ] && { echo "DevTool - í†µí•© ê°œë°œ ë„êµ¬"; echo ""; echo "ì‚¬ìš©: ./devtool"; exit 0; }

show_main_menu
