# 매물 변동사항 추적 UX 설계

## 📋 요구사항 분석

### 사용자 니즈
1. **즉시성**: 지금 당장 변화를 보고 싶다
2. **히스토리**: 시간에 따른 변화 추이를 알고 싶다
3. **알림**: 중요한 변화는 놓치지 않고 싶다

### 변동사항 유형
- **신규 매물**: 새로 등록된 매물
- **소멸 매물**: 사라진 매물 (거래 완료 추정)
- **가격 변동**: 가격 인상/인하
- **상태 변화**: 기타 정보 변경

---

## 🎨 UX 옵션 비교

### 옵션 1: 매물별 뱃지 표시 (인라인)

**장점**
- 한눈에 변화를 파악
- 테이블에서 바로 확인
- 직관적이고 빠른 인지

**단점**
- 테이블이 복잡해질 수 있음
- 변화가 많으면 시끄러움
- 상세 정보 부족

**UI 예시**
```
┌─────────────────────────────────────────────┐
│ 거래유형 │ 가격     │ 평형 │ 동  │ 층 │
├─────────────────────────────────────────────┤
│ 매매 NEW │ 12억5천  │ 59A │ 106 │ 12 │
│ 매매 ↓5% │ 11억8천  │ 84B │ 107 │ 15 │
│ 매매     │ 13억2천  │ 59A │ 108 │ 20 │
└─────────────────────────────────────────────┘
```

---

### 옵션 2: 변동사항 전용 섹션 (분리)

**장점**
- 변화만 집중해서 볼 수 있음
- 상세 정보 제공 가능
- 테이블 깔끔 유지

**단점**
- 두 곳을 확인해야 함
- 전체 맥락 파악이 어려움

**UI 예시**
```
┌─────────────────────────────────────────────┐
│ 📊 최근 변동사항 (3건)                      │
├─────────────────────────────────────────────┤
│ 🆕 신규 매물 1건                            │
│   • 106동 12층 59A형 - 12억5천 (1시간 전)  │
│                                             │
│ 📉 가격 하락 1건                            │
│   • 107동 15층 84B형 - 12억5천 → 11억8천   │
│     (-5.6%, 3시간 전)                       │
│                                             │
│ 🗑️ 소멸 매물 1건                            │
│   • 109동 8층 59A형 - 12억 (거래완료 추정) │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 현재 매물 (24건)                            │
├─────────────────────────────────────────────┤
│ [일반 테이블]                               │
└─────────────────────────────────────────────┘
```

---

### 옵션 3: 하이브리드 (추천! ⭐)

**장점**
- 양쪽의 장점 결합
- 단계적 정보 제공
- 유연한 사용자 선택

**단점**
- 구현 복잡도 증가

**UI 구조**
1. **변동사항 요약 카드** (상단)
2. **매물 테이블 + 인라인 뱃지** (중간)
3. **상세 변동 내역** (하단, 접기/펼치기)

---

## 🎯 최종 제안: 하이브리드 방식

### 1단계: 변동사항 요약 카드 (항상 표시)

```typescript
┌──────────────────────────────────────────────────────────┐
│  📊 매물 변동 현황                    🔄 새로고침 (2분 전) │
├──────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │ 🆕 신규   │  │ 🗑️ 소멸   │  │ 📈 가격↑  │  │ 📉 가격↓  │ │
│  │   1건    │  │   1건    │  │   0건    │  │   1건    │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
│                                                          │
│  💡 최근 변화: 107동 15층 가격 5.6% 하락 (3시간 전)     │
│  [상세 보기 ▼]                                           │
└──────────────────────────────────────────────────────────┘
```

**특징**
- 한눈에 변화 요약
- 클릭하면 상세 내역 펼치기
- 새로고침 버튼과 마지막 업데이트 시간

---

### 2단계: 매물 테이블 + 스마트 뱃지

```typescript
┌─────────────────────────────────────────────────────────┐
│ 현재 매물 (24건)                        [필터] [정렬 ▼] │
├─────────────────────────────────────────────────────────┤
│ 거래 │ 가격     │ 평형 │ 동  │ 층 │ 변동           │   │
├─────────────────────────────────────────────────────────┤
│ 매매 │ 12억5천  │ 59A │ 106 │ 12 │ 🆕 신규 (1h)   │   │
│ 매매 │ 11억8천  │ 84B │ 107 │ 15 │ ↓5.6% (3h)    │   │
│ 매매 │ 13억2천  │ 59A │ 108 │ 20 │ -             │   │
└─────────────────────────────────────────────────────────┘
```

**특징**
- 변동 컬럼 추가 (옵션)
- 24시간 이내 변화만 표시
- 색상 코딩 (신규=초록, 가격↑=빨강, 가격↓=파랑)

---

### 3단계: 상세 변동 타임라인 (접기/펼치기)

```typescript
┌──────────────────────────────────────────────────────────┐
│ 📜 변동 내역 (최근 7일)                    [전체 보기 →] │
├──────────────────────────────────────────────────────────┤
│ 오늘 (3건)                                               │
│ ├─ 15:30  🆕 106동 12층 59A 신규 등록 (12억5천)         │
│ ├─ 14:20  📉 107동 15층 84B 가격 하락                   │
│ │         12억5천 → 11억8천 (-5.6%)                    │
│ └─ 09:15  🗑️ 109동 8층 59A 소멸 (거래완료 추정)        │
│                                                          │
│ 어제 (1건)                                               │
│ └─ 18:45  📈 105동 20층 84B 가격 인상                   │
│           12억 → 12억3천 (+2.5%)                        │
│                                                          │
│ 3일 전 (2건)                                             │
│ ├─ ...                                                   │
└──────────────────────────────────────────────────────────┘
```

**특징**
- 시간순 타임라인
- 일자별 그룹핑
- 필터링 (신규만/가격변동만)

---

## 🔄 데이터 수집 전략

### A. 실시간 새로고침 (즉시성)

```typescript
사용자 클릭 → 크롤링 → 비교 → 결과 표시
```

**장점**
- 즉시 확인 가능
- 사용자 제어

**단점**
- 매번 크롤링 부담
- 변화가 없을 수도

---

### B. 주기적 백그라운드 크롤링 (추천! ⭐)

```typescript
Celery 스케줄러:
- 매일 09:00, 18:00 자동 크롤링
- 변화 감지 시 DB 저장
- 사용자는 저장된 히스토리 조회
```

**장점**
- 서버 부하 분산
- 히스토리 자동 축적
- 주간 브리핑 데이터 활용

**단점**
- 실시간성 부족 (보완: 수동 새로고침 제공)

---

### C. 하이브리드 (최종 추천! ⭐⭐⭐)

```typescript
1. 주기적 크롤링 (하루 2회)
   └─ 변화 자동 감지 및 저장

2. 수동 새로고침 버튼
   ├─ 즉시 크롤링
   ├─ 이전 스냅샷과 비교
   └─ 변화 표시

3. 주간 브리핑
   └─ 주간 변화 요약 리포트
```

**플로우**
```
자동 크롤링 (09:00, 18:00)
    ↓
스냅샷 저장 (ArticleSnapshot)
    ↓
변화 감지 (ArticleChange)
    ↓
    ├─ 즉시 표시 (단지 상세 페이지)
    ├─ 알림 발송 (옵션)
    └─ 주간 집계 (주말)
        ↓
    주간 브리핑 생성
```

---

## 📊 데이터베이스 설계

### ArticleSnapshot 테이블
```sql
CREATE TABLE article_snapshots (
    id SERIAL PRIMARY KEY,
    complex_id VARCHAR(50) NOT NULL,
    snapshot_date TIMESTAMP NOT NULL,

    -- 스냅샷 데이터 (JSON)
    articles_data JSONB NOT NULL,

    -- 통계
    total_count INTEGER,
    sale_count INTEGER,
    lease_count INTEGER,
    avg_sale_price BIGINT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX(complex_id, snapshot_date)
);
```

### ArticleChange 테이블
```sql
CREATE TABLE article_changes (
    id SERIAL PRIMARY KEY,
    complex_id VARCHAR(50) NOT NULL,
    article_no VARCHAR(50),

    -- 변화 유형
    change_type VARCHAR(20) NOT NULL,  -- NEW, REMOVED, PRICE_UP, PRICE_DOWN

    -- 변화 전/후
    old_data JSONB,
    new_data JSONB,

    -- 가격 변화 (금액)
    old_price BIGINT,
    new_price BIGINT,
    price_change_pct FLOAT,

    -- 메타
    detected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_read BOOLEAN DEFAULT FALSE,

    INDEX(complex_id, detected_at),
    INDEX(change_type)
);
```

---

## 🎨 최종 UI 설계

### 단지 상세 페이지 구조

```
┌────────────────────────────────────────────┐
│ 단지 헤더 (이름, 네이버 링크)              │
└────────────────────────────────────────────┘

┌────────────────────────────────────────────┐
│ 통계 카드 (전체/매매/전세)                 │
└────────────────────────────────────────────┘

┌────────────────────────────────────────────┐
│ 📊 매물 변동 현황                          │
│ [신규 1] [소멸 1] [가격↑ 0] [가격↓ 1]     │
│ 🔄 새로고침 (2분 전)    [상세 보기 ▼]     │
└────────────────────────────────────────────┘

┌────────────────────────────────────────────┐
│ 면적별 가격 정보                           │
└────────────────────────────────────────────┘

┌────────────────────────────────────────────┐
│ 현재 매물 (24건)                           │
│ [필터] [정렬]                              │
│                                            │
│ [매물 테이블 with 변동 뱃지]               │
└────────────────────────────────────────────┘

┌────────────────────────────────────────────┐
│ 📜 변동 내역 타임라인 (접기/펼치기)        │
│ [최근 7일간의 모든 변화]                   │
└────────────────────────────────────────────┘
```

---

## 🔔 알림 전략

### 1. 인앱 배지
```typescript
┌─────────────────┐
│ 향촌현대5차  🔴3 │  ← 읽지 않은 변화 개수
└─────────────────┘
```

### 2. 브라우저 알림 (옵션)
```
새 매물이 등록되었습니다!
향촌현대5차 - 106동 12층 59A
12억 5천만원
```

### 3. 이메일 요약 (주간)
```
📊 향촌현대5차 주간 리포트

이번 주 변화:
- 신규 매물: 3건
- 거래 완료: 2건
- 평균 가격: -1.2% ↓
```

---

## 📅 구현 우선순위

### Phase 1: 기본 변화 감지 (1주)
- [x] ArticleSnapshot 모델
- [ ] 수동 새로고침 버튼
- [ ] 이전 스냅샷과 비교 로직
- [ ] 변화 감지 알고리즘

### Phase 2: UI 구현 (1주)
- [ ] 변동사항 요약 카드
- [ ] 매물 테이블 변동 뱃지
- [ ] 상세 타임라인 (접기/펼치기)

### Phase 3: 자동화 (1주)
- [ ] Celery 스케줄러 설정
- [ ] 하루 2회 자동 크롤링
- [ ] 변화 자동 감지 및 저장

### Phase 4: 주간 브리핑 (1주)
- [ ] 주간 데이터 집계
- [ ] 브리핑 리포트 생성
- [ ] 이메일 발송

---

## 💡 UX 인사이트

### 사용자 시나리오 1: 실시간 확인형
```
사용자: "지금 새 매물 나왔나?"
→ 새로고침 버튼 클릭
→ 변동사항 카드에서 즉시 확인
→ 신규 매물에 NEW 뱃지
```

### 사용자 시나리오 2: 트렌드 분석형
```
사용자: "이번 주 가격이 어떻게 변했지?"
→ 변동 내역 타임라인 펼치기
→ 7일간의 가격 변화 확인
→ 주간 브리핑 페이지로 이동
```

### 사용자 시나리오 3: 알림 수신형
```
시스템: 자동 크롤링 (오전 9시)
→ 신규 매물 감지
→ 브라우저 알림 발송
→ 사용자 클릭하여 확인
→ 단지 페이지에서 NEW 뱃지 확인
```

---

## 🎯 핵심 결정사항

### 1. 하이브리드 방식 채택
- **자동 크롤링** (하루 2회) + **수동 새로고침**
- 즉시성과 히스토리 모두 확보

### 2. 3단계 정보 제공
1. **요약 카드**: 빠른 인지
2. **인라인 뱃지**: 맥락 파악
3. **상세 타임라인**: 깊은 분석

### 3. 주간 브리핑 연계
- 매일 수집한 변화 데이터 활용
- 주말에 자동 집계 및 리포트 생성

### 4. 점진적 구현
- Phase 1-2: 수동 새로고침 + 기본 UI
- Phase 3-4: 자동화 + 고급 기능

---

## 📝 구현 체크리스트

### 백엔드
- [ ] ArticleSnapshot 모델
- [ ] ArticleChange 모델
- [ ] 스냅샷 비교 로직
- [ ] 변화 감지 알고리즘
- [ ] API 엔드포인트
  - [ ] POST /api/complexes/{id}/refresh
  - [ ] GET /api/complexes/{id}/changes
  - [ ] GET /api/complexes/{id}/change-summary

### 프론트엔드
- [ ] 새로고침 버튼
- [ ] 변동사항 요약 카드
- [ ] 매물 테이블 변동 컬럼
- [ ] 뱃지 컴포넌트 (NEW, ↑, ↓)
- [ ] 변동 내역 타임라인
- [ ] 로딩 상태 표시

### 자동화 (향후)
- [ ] Celery worker 설정
- [ ] 스케줄 작업 등록
- [ ] 알림 시스템

---

## 🚀 시작하기

다음 중 어떤 것부터 구현할까요?

1. **Phase 1**: 수동 새로고침 + 기본 변화 감지
2. **Phase 2**: UI 먼저 (목업 데이터)
3. **전체**: 한 번에 구현

추천: **Phase 1 → Phase 2** 순서로 점진적 구현
